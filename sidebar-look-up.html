<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <!-- The CSS package applies Google styling to buttons and other elements. -->
    <link rel="stylesheet" href="https://ssl.gstatic.com/docs/script/css/add-ons1.css">

    <style>

        body {
            padding: 0 5px;
            box-sizing: border-box;
        }

        h1 {
            line-height: 1em;
        }

        button {
            margin-top: 10px;
        }

        #columnNameCheckboxContainer {
            width: 100%;
            min-height: 100px;
            max-height: 400px;
            display: flex;
            flex-direction: column;
            border: 1px solid lightgrey;
            border-radius: .4px;
            overflow-y: auto;
            margin-top: 10px;
        }

        #waitMessage {
            display: none;
            font-weight: bold;
        }

        .spinner {
            display: none;
            border: 6px solid #f3f3f3;
            border-top: 6px solid #4787ed;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            margin: 20px auto 20px auto;
            animation: spin 2s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }

        .column-status-spinner {
            display: block;
            width: 14px;
            height: 14px;
            margin: 0 10px 0 auto;
            border: 2px solid #B7BAA7;
            border-top: 2px solid #4787ed;
        }

        .ready-status {
            background-color: rgba(92, 184, 92, 1);
            border-radius: 5px;
            padding: 1px 6px;
            color: white;
            margin-left: auto;
        }


        #loaderSpinnerColumnNames {
            border: 8px solid #f3f3f3;
            border-top: 8px solid #4787ed;
            width: 60px;
            height: 60px;
            margin-top: 40px;
        }

        #errorMessage {
            display: none;
            cursor: pointer;
            margin-top: 20px;
            word-break: break-word;
        }

        #amountOfFindItemsField {
            display: block;
            font-weight: bold;
            margin-top: 10px;
        }


        /* Column item + mapping */

        .column-item-wrapper {
            display: flex;
            align-items: center;
            margin: 4px;
            padding: 4px 10px;
            border: 1px solid lightgrey;
            border-radius: 4px;
        }

        .column-item-wrapper .column-title-checkbox {
            transform: scale(1.5);
        }

        .column-item-wrapper .column-info {
            flex-grow: 1;
            margin-left: 10px;
        }

        .column-item-wrapper .column-info .column-title {
            display: flex;
        }

        .column-item-wrapper .column-info .column-title span {
            font-weight: bold;
            font-size: 1.3em;
        }

        .column-item-wrapper .column-info .column-mapping-wrapper label {
            margin-left: 15px;
        }

    </style>
</head>
<body>

<div class="spinner" id="loaderSpinnerColumnNames"></div>

<form id="findResemblancesForm">
    <h1>Look up</h1>
    <h3>Spreadsheet Columns to look up:</h3>
    <div id="columnNameCheckboxContainer"></div>
    <button type="submit" class="action" id="lookUpBtn">Look Up</button>
    <span id="amountOfFindItemsField">Results: has not started yet</span>
    <button type="button" id="clearMarkBtn" title="Changes background of all rows to white">Clear marks from
        spreadsheet
    </button>
</form>


<p id="waitMessage"></p>
<div class="spinner" id="loaderSpinner"></div>

<span id="errorMessage" class="error" title="Hide"></span>

<script>
    window.onload = () => {
        const pdak = localStorage.getItem('pdak');
        const pdse = localStorage.getItem('pdse');
        if (!pdak || !pdse) {
            showError('Pipedrive Api Key or Smart Email is not provided in settings.');
            document.getElementById('findResemblancesForm').style.display = 'none';
        }

        document.getElementById('findResemblancesForm').style.display = 'none';
        document.getElementById('loaderSpinnerColumnNames').style.display = 'block';

        google.script.run
            .withSuccessHandler(displayColumnNamesCheckboxes)
            .withFailureHandler(showError)
            .getColumnNamesAndIndexes(); // Get column names
    };


    function displayColumnNamesCheckboxes(columnNamesAndIndexesArr) {
        const columnNameCheckboxContainer = document.getElementById('columnNameCheckboxContainer');
        columnNamesAndIndexesArr.forEach(columnNameAndIndexObj => {
            const columnItemWrapper = document.createElement('div'); // Create column item wrapper
            columnItemWrapper.classList.add('column-item-wrapper');
            columnItemWrapper.innerHTML =
                `<input class="column-title-checkbox" type="checkbox">
                 <div class="column-info">
                     <div class="column-title">
                         <span></span>
                     </div>
                     <hr>
                     <div class="column-mapping-wrapper">
                         <select>
                             <option selected="selected" value="">All types</option>
                             <option value="deal">deal</option>
                             <option value="person">person</option>
                             <option value="organization">organization</option>
                             <option value="product">product</option>
                             <option value="file">file</option>
                         </select>
                         <label>
                             <input type="checkbox"">
                             <span>Exact match</span>
                         </label>
                     </div>
                 </div>`;

            // Add column name setting
            columnItemWrapper.querySelector('input.column-title-checkbox').value = columnNameAndIndexObj.columnName;
            columnItemWrapper.querySelector('div.column-title span').textContent = `(${columnNameAndIndexObj.columnIndex}) ${columnNameAndIndexObj.columnName}`;

            columnNameCheckboxContainer.append(columnItemWrapper);
        });

        document.getElementById('findResemblancesForm').style.display = 'block';
        document.getElementById('loaderSpinnerColumnNames').style.display = 'none';
    }


    // Submit form. Start search by selected columns
    document.getElementById('findResemblancesForm').addEventListener('submit', startResemblancesSearchQuery, true);

    function startResemblancesSearchQuery(event) {
        event.preventDefault();
        const selectedColumnObjects = getSelectedColumns(); // Get selected columns {selectedColumn, exactMatch, type}
        if (!selectedColumnObjects) {
            return alert('There is no selected checkboxes');
        }

        deleteStatusesOfColumns(); // Clear all statuses on column checkboxes

        // Start search on each column
        const creds = {
            pdak: localStorage.getItem('pdak'),
            pdse: localStorage.getItem('pdse')
        };

        showWaitMessage(true);
        document.getElementById('lookUpBtn').disabled = true; // Disable [Look Up] during search
        let lookedUpColumnsNumber = 0;
        const totalColumnsNumber = selectedColumnObjects.length;

        let amountOfFindItems = 0;
        document.getElementById('amountOfFindItemsField').textContent = `Results: Processing`;

        selectedColumnObjects.forEach(selectedColumnObj => { // {selectedColumn, exactMatch, type}

            setStatusOfColumn(selectedColumnObj.selectedColumn, 'search'); // Set Search status to column checkbox

            google.script.run
                .withSuccessHandler(function (response) {
                    getSearchResult(response);

                    if (response.length) { // Empty columns return empty array
                        setStatusOfColumn(response[0][0].columnName, 'ready'); // Set Ready status to column checkbox
                    }

                    amountOfFindItems += response.length;

                    lookedUpColumnsNumber++;
                    if (lookedUpColumnsNumber === totalColumnsNumber) { // When search is finished

                        updateStatusesOfEmptyColumn(); // Set Ready statuses for empty column because we cannot use this => response[0][0].columnName

                        showWaitMessage(false);
                        document.getElementById('lookUpBtn').disabled = false; // Enable [Look Up] after search

                        if (amountOfFindItems) { // Update Results (amount of found items) field
                            document.getElementById('amountOfFindItemsField').textContent = `Results: ${amountOfFindItems} matches found`;
                        } else {
                            document.getElementById('amountOfFindItemsField').textContent = `Results: There are no matches with Pipedrive data`;
                        }

                    }
                })
                .withFailureHandler(showError)
                .searchInPDByColumnValues(selectedColumnObj, creds);
        });
    }


    function getSelectedColumns() {
        const selectedColumns = [];
        document.body.querySelectorAll('#columnNameCheckboxContainer input.column-title-checkbox:checked')
            .forEach(selectedColumnCheckbox => {
                const selectedColumnItemWrapper = selectedColumnCheckbox.parentElement;
                selectedColumns.push({
                    selectedColumn: selectedColumnCheckbox.value,
                    exactMatch: selectedColumnItemWrapper.querySelector('.column-mapping-wrapper input').checked,
                    type: selectedColumnItemWrapper.querySelector('.column-mapping-wrapper select').value
                });
            });
        console.log('selectedColumns', selectedColumns);
        return selectedColumns;
    }


    function setStatusOfColumn(selectedColumnName, status) {
        const columnInput = document.body.querySelector(`input[value="${selectedColumnName}"]`);
        const columnInputWrapper = columnInput.parentElement;
        const columnTitleWrapper = columnInputWrapper.querySelector('.column-info .column-title');

        const searchStatusElement = document.createElement('div');
        if (status === 'search') {
            searchStatusElement.classList.add('spinner', 'column-status-spinner');
        } else if (status === 'ready') {
            columnInputWrapper.querySelector('div.spinner.column-status-spinner').remove(); // Delete search spinner
            searchStatusElement.classList.add('ready-status');
            searchStatusElement.textContent = 'Ready';
        }
        columnTitleWrapper.append(searchStatusElement);
    }


    function deleteStatusesOfColumns() {
        document.body.querySelectorAll('div.spinner.column-status-spinner, div.ready-status').forEach(statusItem => {
            statusItem.remove();
        });
    }


    function updateStatusesOfEmptyColumn() {
        document.body.querySelectorAll('div.spinner.column-status-spinner').forEach(statusItem => {
            const labelContainer = statusItem.parentElement;
            const readyStatusItem = document.createElement('div');
            readyStatusItem.classList.add('ready-status');
            readyStatusItem.textContent = 'Ready';
            labelContainer.append(readyStatusItem);
            statusItem.remove();
        });
    }


    function getSearchResult(result) {
        // console.log('result', result);
    }


    // Error, wait and messages
    function showError(msg, element) {
        showWaitMessage(false);
        var errorMessage = document.getElementById('errorMessage');
        errorMessage.textContent = `${msg}. If Look Up button is disabled try to reopen add-on.`;
        errorMessage.style.display = 'block';
        console.error(msg);
    }


    // Hide error message
    document.getElementById('errorMessage').addEventListener('click', function () {
        document.getElementById('errorMessage').style.display = 'none';
    });


    // Show wait message
    function showWaitMessage(showBoolean) {
        const waitMessage = document.getElementById('waitMessage');
        const loaderSpinner = document.getElementById('loaderSpinner');
        if (showBoolean) {
            waitMessage.style.display = 'block';
            waitMessage.textContent = 'Addon is working now. Please, wait for about 1-4 minutes until search is finished.';
            loaderSpinner.style.display = 'block';
        } else {
            waitMessage.style.display = 'none';
            waitMessage.textContent = '';
            loaderSpinner.style.display = 'none';
        }
    }


    // Apply white color to the background of each row
    document.getElementById('clearMarkBtn').addEventListener('click', setWhiteBackgroundOfAllRows, true);

    function setWhiteBackgroundOfAllRows() {
        google.script.run.withSuccessHandler().withFailureHandler(showError).clearMark();
    }
</script>
</body>
</html>